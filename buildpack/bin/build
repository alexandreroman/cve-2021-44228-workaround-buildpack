#!/usr/bin/env bash
set -eo pipefail

layersdir=$1
cvelayer="$layersdir/cve-2021-44228"
mkdir -p "$cvelayer"

# Create a layer which sets an environment variable:
# the idea is to pass '-Dlog4j2.formatMsgNoLookups=true' to
# the JVM process, as a workaround for CVE-2021-44228.
envlayer="$cvelayer/env.launch"
mkdir -p "$envlayer"
echo " -Dlog4j2.formatMsgNoLookups=true " > "$envlayer/JAVA_TOOL_OPTIONS.append"

# Export this layer in the resulting image.
layerfile="$cvelayer.toml"
cat > "$layerfile" << EOF
[types]
  launch = true
EOF
